     {%- when 'frequently_bought' -%}
        {% assign fbt_products = product.metafields.custom.frequently_bought_together_list.value %}

{% if fbt_products.size > 0 %}
<div class="fbt-section" data-section-id="{{ section.id }}">
  <h2 class="fbt-heading">{{ block.settings.heading }}</h2>
  
  <div class="fbt-container">
    <!-- Product Images Row -->
    <div class="fbt-images-row">
      <!-- Main Product Image -->
      <a href="{{ product.url }}" class="fbt-image-link">
        <div class="fbt-image-wrapper">
          <img src="{{ product.selected_or_first_available_variant.image | default: product.featured_image | image_url: width: 100 }}" 
               alt="{{ product.title }}" 
               loading="lazy">
        </div>
      </a>

      <span class="fbt-plus">+</span>

      <!-- Related Products Images -->
      {% for fbt_product in fbt_products %}
        <a href="{{ fbt_product.url }}" class="fbt-image-link" data-product-id="{{ fbt_product.id }}">
          <div class="fbt-image-wrapper">
            <img src="{{ fbt_product.selected_or_first_available_variant.image | default: fbt_product.featured_image | image_url: width: 100 }}" 
                 alt="{{ fbt_product.title }}" 
                 loading="lazy"
                 class="fbt-variant-image-{{ fbt_product.id }}">
          </div>
        </a>

        {% unless forloop.last %}
          <span class="fbt-plus">+</span>
        {% endunless %}
      {% endfor %}
    </div>

    <!-- Total Price -->
    <div class="fbt-total-price-row">
      <span class="fbt-total-label">Total Price:</span>
      <span class="fbt-total-amount" data-total="{{ product.selected_or_first_available_variant.price }}">
        {{ product.selected_or_first_available_variant.price | money }}
      </span>
    </div>

    <!-- Add to Cart Button -->
    <button type="button" class="fbt-add-to-cart-button">{{ block.settings.button_text }}</button>

    <!-- Product List with Checkboxes -->
    <div class="fbt-products-list">
      <!-- Main Product -->
      <div class="fbt-product-row">
        <input type="checkbox" class="fbt-checkbox" id="fbt-main-{{ product.id }}" checked disabled data-price="{{ product.selected_or_first_available_variant.price }}">
        <div class="fbt-product-info">
          <span class="fbt-this-item">This item:</span>
          <a href="{{ product.url }}" class="fbt-product-link">
            <strong class="fbt-product-name">{{ product.title | upcase }}</strong>
          </a>
        </div>
        <span class="fbt-product-price">{{ product.selected_or_first_available_variant.price | money }}</span>
      </div>

      <!-- Related Products -->
      {% for fbt_product in fbt_products %}
        <div class="fbt-product-row">
          <input type="checkbox" class="fbt-checkbox" id="fbt-{{ fbt_product.id }}" checked data-price="{{ fbt_product.selected_or_first_available_variant.price }}" data-variant-id="{{ fbt_product.selected_or_first_available_variant.id }}">
          <div class="fbt-product-info">
            <a href="{{ fbt_product.url }}" class="fbt-product-link">
              <strong class="fbt-product-name">{{ fbt_product.title | upcase }}</strong>
            </a>
          </div>
          <span class="fbt-product-price fbt-price-{{ fbt_product.id }}">{{ fbt_product.selected_or_first_available_variant.price | money }}</span>
        </div>

        {% if fbt_product.has_only_default_variant == false %}
          <div class="fbt-variant-row">
            <select class="fbt-variant-select" data-product-id="{{ fbt_product.id }}">
              {% for variant in fbt_product.variants %}
                <option value="{{ variant.id }}" 
                        data-price="{{ variant.price }}"
                        data-image="{{ variant.image | image_url: width: 100 }}"
                        {% if variant.available == false %}disabled{% endif %}
                        {% if variant.id == fbt_product.selected_or_first_available_variant.id %}selected{% endif %}>
                  {{ variant.title }}
                  {% unless variant.available %} (Sold Out){% endunless %}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>

<style>
.fbt-section {
  margin: 40px auto;
  padding: 0;
  max-width: 600px;
}

.fbt-heading {
  text-align: center;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 30px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #000;
}

.fbt-container {
  background: #fff;
}

/* Images Row */
.fbt-images-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  margin-bottom: 20px;
  padding: 0 20px;
}

.fbt-image-link {
  text-decoration: none;
  flex-shrink: 0;
  transition: transform 0.2s ease;
}

.fbt-image-link:hover {
  transform: scale(1.05);
}

.fbt-image-wrapper {
  width: 80px;
  height: 80px;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  overflow: hidden;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}

.fbt-image-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.fbt-plus {
  font-size: 20px;
  font-weight: 400;
  color: #666;
  flex-shrink: 0;
}

/* Total Price Row */
.fbt-total-price-row {
  text-align: center;
  margin-bottom: 20px;
  font-size: 18px;
  color: #000;
}

.fbt-total-label {
  font-weight: 400;
  margin-right: 8px;
}

.fbt-total-amount {
  font-weight: 700;
  font-size: 20px;
}

/* Add to Cart Button */
.fbt-add-to-cart-button {
  width: 100%;
  background-color: #F5CC02;
  border: none;
  padding: 16px 24px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 25px;
}

.fbt-add-to-cart-button:hover {
  background-color:rgb(215, 182, 17);
}

.fbt-add-to-cart-button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

/* Products List */
.fbt-products-list {
  padding: 0;
}

.fbt-product-row {
  display: flex;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #f0f0f0;
}

.fbt-product-row:last-of-type {
  border-bottom: none;
}

.fbt-checkbox {
  width: 18px;
  height: 18px;
  margin-right: 12px;
  cursor: pointer;
  flex-shrink: 0;
  accent-color: #F5CC02;
}

.fbt-checkbox:disabled {
  cursor: not-allowed;
}

.fbt-product-info {
  flex: 1;
  font-size: 14px;
  line-height: 1.4;
  color: #333;
  display: flex;
  align-items: center;
  gap: 5px;
  flex-wrap: wrap;
}

.fbt-this-item {
  font-weight: 400;
  color: #666;
}

.fbt-product-link {
  text-decoration: none;
  color: inherit;
  transition: color 0.2s ease;
}

.fbt-product-link:hover {
  color: #00bcd4;
}

.fbt-product-name {
  font-weight: 600;
  color: #000;
  font-size: 13px;
}

.fbt-product-link:hover .fbt-product-name {
  color: #00bcd4;
}

.fbt-product-price {
  font-weight: 600;
  color: #000;
  font-size: 14px;
  margin-left: 12px;
  flex-shrink: 0;
}

/* Variant Selector Row */
.fbt-variant-row {
  padding: 0 0 12px 30px;
  border-bottom: 1px solid #f0f0f0;
}

.fbt-variant-select {
  width: 100%;
  max-width: 400px;
  padding: 10px 12px;
  border: 1px solid #d0d0d0;
  border-radius: 4px;
  font-size: 14px;
  background-color: #fff;
  cursor: pointer;
  color: #333;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

.fbt-variant-select:focus {
  outline: none;
  border-color: #00bcd4;
}

/* Responsive Design */
@media (max-width: 600px) {
  .fbt-section {
    padding: 0 15px;
  }

  .fbt-images-row {
    flex-wrap: wrap;
    gap: 10px;
  }

.fbt-image-wrapper {
    width: 75px;
    height: 75px;
}

  .fbt-plus {
    font-size: 16px;
  }

  .fbt-heading {
    font-size: 20px;
  }

  .fbt-product-name {
    font-size: 12px;
  }

  .fbt-variant-select {
    font-size: 13px;
  }
}
</style>

<script>
(function() {
  const section = document.querySelector('[data-section-id="{{ section.id }}"]');
  if (!section) return;

  const checkboxes = section.querySelectorAll('.fbt-checkbox:not([disabled])');
  const totalAmountElement = section.querySelector('.fbt-total-amount');
  const addToCartBtn = section.querySelector('.fbt-add-to-cart-button');
  const variantSelects = section.querySelectorAll('.fbt-variant-select');

  // Get Shopify's money format
  const moneyFormat = '{{ shop.money_format }}';

  // Prevent checkbox toggle when clicking on product links
  const productLinks = section.querySelectorAll('.fbt-product-link');
  productLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });

  // Calculate total price
  function calculateTotal() {
    let total = 0;
    const mainProductPrice = parseInt(section.querySelector('.fbt-product-row:first-child .fbt-checkbox').dataset.price);
    total += mainProductPrice;

    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        total += parseInt(checkbox.dataset.price);
      }
    });

    totalAmountElement.textContent = formatMoney(total);
  }

  // Format money properly
  function formatMoney(cents) {
    if (typeof cents === 'string') {
      cents = cents.replace('.', '');
    }
    
    let value = '';
    const placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
    const formatString = moneyFormat;

    function formatWithDelimiters(number, precision, thousands, decimal) {
      precision = precision || 2;
      thousands = thousands || ',';
      decimal = decimal || '.';

      if (isNaN(number) || number == null) {
        return '0';
      }

      number = (number / 100.0).toFixed(precision);

      const parts = number.split('.');
      const dollarsAmount = parts[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1' + thousands);
      const centsAmount = parts[1] ? (decimal + parts[1]) : '';

      return dollarsAmount + centsAmount;
    }

    switch (formatString.match(placeholderRegex)[1]) {
      case 'amount':
        value = formatWithDelimiters(cents, 2);
        break;
      case 'amount_no_decimals':
        value = formatWithDelimiters(cents, 0);
        break;
      case 'amount_with_comma_separator':
        value = formatWithDelimiters(cents, 2, '.', ',');
        break;
      case 'amount_no_decimals_with_comma_separator':
        value = formatWithDelimiters(cents, 0, '.', ',');
        break;
      case 'amount_with_apostrophe_separator':
        value = formatWithDelimiters(cents, 2, "'", '.');
        break;
    }

    return formatString.replace(placeholderRegex, value);
  }

  // Handle variant selection
  variantSelects.forEach(select => {
    select.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const productId = this.dataset.productId;
      const checkbox = section.querySelector(`#fbt-${productId}`);
      const priceElement = section.querySelector(`.fbt-price-${productId}`);
      const image = section.querySelector(`.fbt-variant-image-${productId}`);

      // Update variant ID
      checkbox.dataset.variantId = selectedOption.value;
      
      // Update price
      const newPrice = selectedOption.dataset.price;
      checkbox.dataset.price = newPrice;
      priceElement.textContent = formatMoney(parseInt(newPrice));

      // Update image if variant has one
      const variantImage = selectedOption.dataset.image;
      if (variantImage && variantImage !== '' && variantImage !== 'null') {
        image.src = variantImage;
      }

      calculateTotal();
    });
  });

  // Handle checkbox changes - only when clicking directly on checkbox
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', calculateTotal);
  });

  // Handle Add to Cart
  addToCartBtn.addEventListener('click', async function() {
    const originalText = this.textContent;
    this.disabled = true;
    this.textContent = 'Adding...';

    const items = [];
    
    // Add main product
    items.push({
      id: {{ product.selected_or_first_available_variant.id }},
      quantity: 1
    });

    // Add selected related products
    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        items.push({
          id: parseInt(checkbox.dataset.variantId),
          quantity: 1
        });
      }
    });

    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ items })
      });

      if (response.ok) {
        // Update cart count if you have a cart drawer
        if (typeof window.dispatchEvent !== 'undefined') {
          window.dispatchEvent(new Event('cart:refresh'));
        }
        
        // Show success message or redirect to cart
        this.textContent = 'Added!';
        setTimeout(() => {
          window.location.href = '/cart';
        }, 500);
      } else {
        const errorData = await response.json();
        throw new Error(errorData.description || 'Failed to add to cart');
      }
    } catch (error) {
      console.error('Error:', error);
      alert(error.message || 'There was an error adding items to cart. Please try again.');
      this.disabled = false;
      this.textContent = originalText;
    }
  });

  // Initial calculation
  calculateTotal();
})();
</script>
{% endif %}

 



 {
 "type": "frequently_bought",
      "name": "Frequently bought ",
      "limit": 1,
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "FREQUENTLY BOUGHT TOGETHER"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Add to Cart"
    }
  ],
 
},